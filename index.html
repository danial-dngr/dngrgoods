<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DNGR GOODS</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script type="module" src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"></script>

  <style>
    :root {
      --bg-primary: white;
      --bg-secondary: #f8f8f8;
      --text-primary: black;
      --text-secondary: #333;
      --border-color: #ddd;
      --shadow-color: rgba(0,0,0,0.2);
      --hover-color: #0066cc;

      /* DOS/brutalist scrollbar colors */
      --scrollbar-thumb: #888;
      --scrollbar-track: #111;

      /* Swiss grid */
      --swiss-columns: 12;
      --swiss-gap: 15px;
      --swiss-row: 12px; /* baseline row height */

      /* Bottom menu columns (sync with info bar) */
      --menu-cols: 5;

      /* Overlap in grid mode (~15px) */
      --overlap-offset: -15px;
    }

    @media (max-width: 800px) {
      :root { --menu-cols: 2; }
    }

    body.dark-mode {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2a2a2a;
      --text-primary: #f0f0f0;
      --text-secondary: #c0c0c0;
      --border-color: #444;
      --shadow-color: rgba(255,255,255,0.1);
      --hover-color: #66b3ff;

      --scrollbar-thumb: #c0c0c0;
      --scrollbar-track: #111;
    }

    @font-face {
      font-family: "Neue Montreal Mono";
      src: url("path-to-neue-montreal-mono.woff2") format("woff2");
      font-display: swap;
    }

    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
    }

    body {
      overflow-x: hidden; /* prevent side scroll */
      overflow-y: hidden;
      background: var(--bg-primary);
      font-family: "Neue Montreal Mono", monospace;
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* === DOS / Brutalist scrollbars === */
    * {
      scrollbar-width: thin; /* Firefox */
      scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-track);
    }
    .content ul::-webkit-scrollbar,
    .grid-container::-webkit-scrollbar,
    .preview::-webkit-scrollbar {
      width: 10px; height: 10px;
    }
    .content ul::-webkit-scrollbar-thumb,
    .grid-container::-webkit-scrollbar-thumb,
    .preview::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border: 2px solid var(--scrollbar-track);
      border-radius: 0; /* square corners */
    }
    .content ul::-webkit-scrollbar-track,
    .grid-container::-webkit-scrollbar-track,
    .preview::-webkit-scrollbar-track {
      background: var(--scrollbar-track);
    }

    .branding {
      position: fixed; top: 20px; left: 20px;
      font-size: clamp(16px, 2vw, 28px);
      z-index: 100;
      color: var(--text-primary);
      text-transform: uppercase;
      display: flex; align-items: center; gap: 12px;
    }
    .branding-text { line-height: 1; }

    .control-buttons { display: flex; gap: 8px; margin-left: 20px; }
    .control-button {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      cursor: pointer;
      padding: 8px 12px;
      font-family: inherit;
      font-size: 16px;
      transition: all 0.2s ease;
      border-radius: 4px;
    }
    .control-button:hover {
      border-color: var(--text-primary);
      background: var(--text-primary);
      color: var(--bg-primary);
    }

    /* === Bottom Projects Menu (fixed & on top) === */
    .content {
      position: fixed; bottom: 0; left: 0; right: 0;
      width: 100%; height: 20vh;
      z-index: 10000; /* stay above everything */
      border-top: 1px solid var(--border-color);
      padding: 10px 10px 8px 10px;
      background: var(--bg-secondary);
      overflow: hidden; /* inner elements manage scroll */
      display: grid; grid-template-rows: auto 1fr auto; /* title | list | info bar */
      box-sizing: border-box;
      transition: background 0.3s ease, border-color 0.3s ease;
    }
    .content h4 {
      font-weight: 400; font-size: clamp(14px, 1.4vw, 18px);
      margin: 0 0 6px 0; color: var(--text-primary);
      text-transform: uppercase; letter-spacing: 0.5px; line-height: 1;
    }
    .content ul {
      list-style: none; padding: 0; margin: 0;
      font-size: clamp(14px, 1.4vw, 18px);
      display: grid; grid-template-columns: repeat(var(--menu-cols), 1fr);
      gap: 0; row-gap: clamp(0.5px, 0.3vw, 3px);
      overflow-y: auto; overflow-x: hidden; /* vertical only */
      line-height: 1;
    }
    .content ul li {
      cursor: pointer; margin: 0; color: var(--text-primary); font-weight: 400;
      padding-right: clamp(6px, 1vw, 12px); border-right: 1px solid var(--border-color);
      text-transform: uppercase; line-height: 1;
      padding-bottom: clamp(0.5px, 0.3vw, 2px);
      transition: color 0.2s ease; white-space: nowrap;
    }
    .content ul li:last-child { border-right: none; }
    .content ul li:hover { color: var(--hover-color); }
    .content ul li span {
      font-weight: 700; font-size: clamp(10px, 1vw, 11px);
      margin-right: clamp(3px, 0.5vw, 6px); color: var(--text-primary);
    }

    /* Info bar moved into menu as single line */
    .info-bar {
      display: grid; grid-template-columns: repeat(var(--menu-cols), 1fr);
      column-gap: 0;
      font-size: clamp(10px, 1.1vw, 12px);
      color: var(--text-primary);
      margin-top: 6px;
      border-top: 1px solid var(--border-color);
      padding-top: 6px;
      white-space: nowrap;
      align-items: center;
    }
    .info-cell {
      padding-right: clamp(6px, 1vw, 12px);
      border-right: 1px solid var(--border-color);
      text-transform: uppercase;
      overflow: hidden; text-overflow: ellipsis;
    }
    .info-cell:last-child { border-right: none; }
    .info-cell a { color: inherit; text-decoration: none; }
    .info-cell a:hover { text-decoration: underline; }

    /* Original footer is hidden to avoid duplication */
    .footer { display: none; }

    .lottie-wrapper {
      position: fixed; top: 20px; left: 20px;
      z-index: 6; width: clamp(40px, 8vw, 80px); height: clamp(40px, 8vw, 80px);
      pointer-events: none;
    }
    .lottie-wrapper dotlottie-player {
      width: 100%; height: 100%; background: transparent !important;
    }

    /* === Grid Area === */
    .grid-container {
      position: fixed;
      top: 80px; left: 20px; right: 20px; bottom: calc(20vh + 10px);
      z-index: 15;
      display: none;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      grid-auto-rows: minmax(200px, auto);
      gap: var(--swiss-gap);
      overflow-y: auto; overflow-x: hidden;
      padding: 10px;
    }
    .grid-container.active {
      display: grid;
      grid-template-columns: repeat(var(--swiss-columns), 1fr);
      grid-auto-rows: var(--swiss-row);
      grid-auto-flow: dense; /* better packing */
    }

    .grid-container .preview {
      position: relative !important;
      transform: translate(var(--overlap-offset), var(--overlap-offset)) !important; /* ~15px overlap */
      top: auto !important; left: auto !important;
      width: 100% !important; height: auto !important;
      min-width: auto !important; min-height: auto !important;
      box-shadow: 0 2px 10px var(--shadow-color);
      resize: none; /* disabled in grid */
      z-index: auto;
    }

    /* === Preview windows === */
    .preview {
      position: absolute;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      z-index: 20;
      width: 600px; min-width: 200px;
      height: auto; min-height: 300px;
      border: none; padding: 30px;
      background: var(--bg-primary);
      overflow: auto; /* vertical scroll shows DOS scrollbar */
      resize: both; cursor: default;
      box-shadow: 0 4px 20px var(--shadow-color);
      transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    }

    .close-button {
      position: absolute; top: 20px; right: 20px;
      padding: 5px 10px; background: transparent;
      color: var(--text-secondary); border: 1px solid var(--border-color);
      cursor: pointer; font-size: 14px; font-family: inherit;
      transition: all 0.2s; z-index: 30; pointer-events: auto;
    }
    .close-button:hover { color: var(--text-primary); border-color: var(--text-primary); }
    .close-button::before { content: "Ã—"; font-weight: bold; font-size: 20px; }

    /* Title ABOVE image (as you liked) */
    .preview-title {
      font-size: 16px; font-weight: 700;
      margin: 0 0 12px 0; color: var(--text-primary);
      text-transform: uppercase; letter-spacing: 0.5px; line-height: 1.2;
    }

    .preview-image-wrapper { width: 100%; margin-bottom: 14px; }
    .preview-image-wrapper img, .preview-image-wrapper video {
      width: 100%; height: auto; display: block; border: none;
    }

    .preview-blurb {
      font-size: 11px; line-height: 1.4; color: var(--text-secondary);
      text-align: justify; margin: 0; text-transform: uppercase; letter-spacing: 0.3px;
    }

    .preview-blurb img {
      float: left; margin: 0 12px 8px 0; border: 1px solid var(--border-color);
      height: 45px; width: auto; object-fit: cover;
    }
    .preview-blurb img:nth-of-type(2) { float: right; margin: 0 0 8px 12px; }

    .three-container { position: fixed; inset: 0; pointer-events: none; z-index: 1; display: none; }

    /* Grid mode UI */
    .preview .grid-resize { display: none; }
    .preview.in-grid .grid-resize {
      display: block; position: absolute; right: 6px; bottom: 6px;
      width: 16px; height: 16px; cursor: nwse-resize; z-index: 40; opacity: 0.75;
      background:
        linear-gradient(135deg, transparent 50%, var(--border-color) 50%) no-repeat,
        linear-gradient(135deg, transparent 40%, var(--text-secondary) 40%) no-repeat;
      background-size: 100% 100%, 6px 6px;
    }
    .preview.in-grid .grid-resize:hover { opacity: 1; }
    .preview.in-grid { cursor: move; }
    .preview.in-grid.dragging { opacity: 0.92; box-shadow: 0 6px 18px var(--shadow-color); }
  </style>
</head>
<body>
  <div class="lottie-wrapper" aria-hidden="true">
    <dotlottie-player
      src="https://lottie.host/d78de815-63f5-4083-8b23-d3833bcfd65f/1aTwDaznYJ.lottie"
      background="transparent"
      speed="0.5"
      loop
      autoplay>
    </dotlottie-player>
  </div>

  <div class="branding">
    <div class="branding-text" aria-label="DNGR GOODS">DNGR GOODS</div>
    <div class="control-buttons">
      <button class="control-button" id="invertBtn" title="Toggle Dark Mode">ðŸŒ“</button>
      <button class="control-button" id="gridBtn" title="Toggle Grid Layout">âŠž</button>
    </div>
  </div>

  <div class="grid-container" id="gridContainer" aria-live="polite"></div>

  <div class="content">
    <h4>Projects</h4>
    <ul id="projectList">
      <li data-project="SOLARIS"><span>01</span>SOLARIS</li>
      <li data-project="GO MAD"><span>02</span>GO MAD</li>
      <li data-project="LSW"><span>03</span>LSW</li>
      <li data-project="VANCE LIVING"><span>04</span>VANCE LIVING</li>
      <li data-project="ABOUT DNGR"><span>05</span>ABOUT DNGR</li>
      <li data-project="NOCTURNAL INGESTIONS"><span>06</span>NOCTURNAL</li>
      <li data-project="THAIMESE"><span>07</span>THAIMESE</li>
      <li data-project="KINETIC MOTION"><span>08</span>KINETIC MOTION</li>
      <li data-project="PROJECT NINE"><span>09</span>PROJECT NINE</li>
      <li data-project="PROJECT TEN"><span>10</span>PROJECT TEN</li>
      <li data-project="PROJECT ELEVEN"><span>11</span>PROJECT ELEVEN</li>
      <li data-project="PROJECT TWELVE"><span>12</span>PROJECT TWELVE</li>
      <li data-project="PROJECT THIRTEEN"><span>13</span>PROJECT THIRTEEN</li>
      <li data-project="PROJECT FOURTEEN"><span>14</span>PROJECT FOURTEEN</li>
      <li data-project="PROJECT FIFTEEN"><span>15</span>PROJECT FIFTEEN</li>
      <li data-project="PROJECT SIXTEEN"><span>16</span>PROJECT SIXTEEN</li>
      <li data-project="PROJECT SEVENTEEN"><span>17</span>PROJECT SEVENTEEN</li>
      <li data-project="PROJECT EIGHTEEN"><span>18</span>PROJECT EIGHTEEN</li>
      <li data-project="PROJECT NINETEEN"><span>19</span>PROJECT NINETEEN</li>
      <li data-project="PROJECT TWENTY"><span>20</span>PROJECT TWENTY</li>
      <li data-project="PROJECT TWENTY-ONE"><span>21</span>PROJECT TWENTY-ONE</li>
      <li data-project="PROJECT TWENTY-TWO"><span>22</span>PROJECT TWENTY-TWO</li>
      <li data-project="PROJECT TWENTY-THREE"><span>23</span>PROJECT TWENTY-THREE</li>
      <li data-project="PROJECT TWENTY-FOUR"><span>24</span>PROJECT TWENTY-FOUR</li>
      <li data-project="PROJECT TWENTY-FIVE"><span>25</span>PROJECT TWENTY-FIVE</li>
    </ul>

    <!-- Footer info moved into menu -->
    <div class="info-bar" id="infoBar">
      <div class="info-cell">DNGR GOODS</div>
      <div class="info-cell">DANIAL GRAHAM</div>
      <div class="info-cell">GOODS &amp; VISUAL SERVICES</div>
      <div class="info-cell"><a href="mailto:danial@dngrgoods.com">DANIAL@DNGRGOODS.COM</a></div>
      <div class="info-cell"><a href="tel:+61400165501">0400 165 501</a></div>
    </div>
  </div>

  <div class="three-container"></div>

  <script>
    const openPreviews = {};
    let gridMode = false;
    let zIndex = 10;

    // Theme toggle
    const invertBtn = document.getElementById('invertBtn');
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    if (savedDarkMode) document.body.classList.add('dark-mode');
    invertBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
    });

    // Grid toggle
    const gridBtn = document.getElementById('gridBtn');
    const gridContainer = document.getElementById('gridContainer');
    gridBtn.addEventListener('click', () => {
      gridMode = !gridMode;
      gridContainer.classList.toggle('active', gridMode);
      if (gridMode) reorganizePreviewsInGrid();
      else resetPreviewsToAbsolute();
    });

    // Free mode dragging
    const makeDraggable = (element) => {
      let isDragging = false, sx, sy, ex, ey;
      const start = (e) => {
        if (gridMode) return;
        isDragging = true;
        sx = e.touches ? e.touches[0].clientX : e.clientX;
        sy = e.touches ? e.touches[0].clientY : e.clientY;
        ex = element.offsetLeft; ey = element.offsetTop;
        element.style.cursor = 'grabbing';
        element.style.zIndex = `${++zIndex}`;
      };
      const move = (e) => {
        if (!isDragging || gridMode) return;
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        element.style.left = `${ex + (cx - sx)}px`;
        element.style.top  = `${ey + (cy - sy)}px`;
      };
      const stop = () => { isDragging = false; element.style.cursor = gridMode ? 'default' : 'grab'; };
      element.addEventListener('mousedown', start); element.addEventListener('mousemove', move);
      element.addEventListener('mouseup', stop); element.addEventListener('mouseleave', stop);
      element.addEventListener('touchstart', start, {passive:false});
      element.addEventListener('touchmove', move, {passive:false});
      element.addEventListener('touchend', stop); element.addEventListener('touchcancel', stop);
    };

    // Project data (you can replace placeholders with your actual assets)
    const projectData = {
      'SOLARIS': {
        image: 'https://github.com/danial-dngr/dngrgoods/blob/main/Holiday%20Sauce%20-%20Holding%20Sea%20horse%20.png?raw=true',
        blurb: '<img src="https://github.com/danial-dngr/dngrgoods/blob/main/Holiday%20Sauce%20-%20Instax%20Photo.png?raw=true" alt="detail" /> SOLARIS IS AN EXPLORATION INTO MINIMAL SOLAR HOUSING FOR URBAN SPACES.'
      },
      'GO MAD': { image: 'https://via.placeholder.com/1200x700/000000/FFFFFF?text=GO+MAD', blurb: 'GO MAD IS AN ENERGETIC PROJECT AIMED AT CAPTURING HUMAN CREATIVITY.' },
      'LSW': { image: 'https://via.placeholder.com/1200x700/003300/FFFFFF?text=LSW', blurb: 'LSW ENCAPSULATES THE ESSENCE OF LIVING SIMPLY WITH WATER THEMES.' },
      'VANCE LIVING': { image: 'https://via.placeholder.com/1200x700/330033/FFFFFF?text=VANCE+LIVING', blurb: 'VANCE LIVING REIMAGINES MODULAR ARCHITECTURE IN DAILY LIFE.' },
      'ABOUT DNGR': { image: 'https://dngrgoods.com/wp-content/uploads/2023/07/DSC01289-1.png', blurb: 'CREATIVE DIRECTION, BRAND IDENTITY, TYPOGRAPHY, LOGO & STRATEGIC DESIGN.' },
      'NOCTURNAL INGESTIONS': {
        image: 'https://github.com/danial-dngr/dngrgoods/blob/main/Screen%20Shot%202022-11-03%20at%205.31.19%20pm.png?raw=true',
        blurb: 'LATE NIGHT RESTAURANT IDENTITY WITH BENDIGO HOTEL, COLLINGWOOD.'
      },
      'THAIMESE': {
        image: 'https://github.com/danial-dngr/dngrgoods/blob/main/MMALE%20MODEL%20WEARING%20SHIRT%20FUll.jpg?raw=true',
        blurb: 'THAIMESE PROJECT DESCRIPTION HERE.'
      },
      'KINETIC MOTION': {
        image: 'https://github.com/danial-dngr/dngrgoods/blob/main/FINDING%20TIME%203.mp4?raw=true',
        blurb: 'KINETIC MOTION EXPLORES DYNAMIC MOVEMENT AND VISUAL RHYTHM.'
      },
      'PROJECT NINE': { image: 'https://via.placeholder.com/1200x700/111111/FFFFFF?text=PROJECT+NINE', blurb: 'PROJECT NINE DESCRIPTION.' },
      'PROJECT TEN': { image: 'https://via.placeholder.com/1200x700/1a1a1a/FFFFFF?text=PROJECT+TEN', blurb: 'PROJECT TEN DESCRIPTION.' },
      'PROJECT ELEVEN': { image: 'https://via.placeholder.com/1200x700/222222/FFFFFF?text=PROJECT+ELEVEN', blurb: 'PROJECT ELEVEN DESCRIPTION.' },
      'PROJECT TWELVE': { image: 'https://via.placeholder.com/1200x700/2a2a2a/FFFFFF?text=PROJECT+TWELVE', blurb: 'PROJECT TWELVE DESCRIPTION.' },
      'PROJECT THIRTEEN': { image: 'https://via.placeholder.com/1200x700/333333/FFFFFF?text=PROJECT+THIRTEEN', blurb: 'PROJECT THIRTEEN DESCRIPTION.' },
      'PROJECT FOURTEEN': { image: 'https://via.placeholder.com/1200x700/3a3a3a/FFFFFF?text=PROJECT+FOURTEEN', blurb: 'PROJECT FOURTEEN DESCRIPTION.' },
      'PROJECT FIFTEEN': { image: 'https://via.placeholder.com/1200x700/444444/FFFFFF?text=PROJECT+FIFTEEN', blurb: 'PROJECT FIFTEEN DESCRIPTION.' },
      'PROJECT SIXTEEN': { image: 'https://via.placeholder.com/1200x700/4a4a4a/FFFFFF?text=PROJECT+SIXTEEN', blurb: 'PROJECT SIXTEEN DESCRIPTION.' },
      'PROJECT SEVENTEEN': { image: 'https://via.placeholder.com/1200x700/555555/FFFFFF?text=PROJECT+SEVENTEEN', blurb: 'PROJECT SEVENTEEN DESCRIPTION.' },
      'PROJECT EIGHTEEN': { image: 'https://via.placeholder.com/1200x700/5a5a5a/FFFFFF?text=PROJECT+EIGHTEEN', blurb: 'PROJECT EIGHTEEN DESCRIPTION.' },
      'PROJECT NINETEEN': { image: 'https://via.placeholder.com/1200x700/666666/FFFFFF?text=PROJECT+NINETEEN', blurb: 'PROJECT NINETEEN DESCRIPTION.' },
      'PROJECT TWENTY': { image: 'https://via.placeholder.com/1200x700/6a6a6a/FFFFFF?text=PROJECT+TWENTY', blurb: 'PROJECT TWENTY DESCRIPTION.' },
      'PROJECT TWENTY-ONE': { image: 'https://via.placeholder.com/1200x700/777777/FFFFFF?text=PROJECT+TWENTY-ONE', blurb: 'PROJECT TWENTY-ONE DESCRIPTION.' },
      'PROJECT TWENTY-TWO': { image: 'https://via.placeholder.com/1200x700/7a7a7a/FFFFFF?text=PROJECT+TWENTY-TWO', blurb: 'PROJECT TWENTY-TWO DESCRIPTION.' },
      'PROJECT TWENTY-THREE': { image: 'https://via.placeholder.com/1200x700/858585/FFFFFF?text=PROJECT+TWENTY-THREE', blurb: 'PROJECT TWENTY-THREE DESCRIPTION.' },
      'PROJECT TWENTY-FOUR': { image: 'https://via.placeholder.com/1200x700/909090/FFFFFF?text=PROJECT+TWENTY-FOUR', blurb: 'PROJECT TWENTY-FOUR DESCRIPTION.' },
      'PROJECT TWENTY-FIVE': { image: 'https://via.placeholder.com/1200x700/999999/FFFFFF?text=PROJECT+TWENTY-FIVE', blurb: 'PROJECT TWENTY-FIVE DESCRIPTION.' }
    };

    /* === Helpers === */
    const getGridMetrics = () => {
      const styles = getComputedStyle(gridContainer);
      const root = getComputedStyle(document.documentElement);
      const cols = parseInt(root.getPropertyValue('--swiss-columns')) || 12;
      const gap = parseFloat(styles.gap || styles.columnGap || '15') || 15;
      const rect = gridContainer.getBoundingClientRect();
      const colWidth = (rect.width - gap * (cols - 1)) / cols;
      const rh = parseFloat(root.getPropertyValue('--swiss-row')) || 12;
      const effCol = colWidth + gap;
      const effRow = rh + gap;
      const containerHeight = rect.height;
      return { cols, gap, colWidth, rh, effCol, effRow, containerHeight };
    };

    const autoSizeRowSpan = (preview, minRows=1) => {
      if (!gridMode) return;
      const { rh, gap } = getGridMetrics();
      const h = preview.getBoundingClientRect().height;
      const rows = Math.max(minRows, Math.round((h + gap) / (rh + gap)));
      preview.dataset.rowSpan = String(rows);
      preview.style.gridRow = `span ${rows}`;
    };

    const createMediaEl = (src, alt) => {
      const isVideo = /\.(mp4|webm|ogg)(\?.*)?$/i.test(src);
      if (isVideo) {
        const v = document.createElement('video');
        v.src = src; v.controls = true; v.loop = true; v.muted = true; v.playsInline = true; v.autoplay = true;
        v.setAttribute('aria-label', alt || 'Project video'); v.preload = 'metadata';
        return v;
      } else {
        const img = document.createElement('img');
        img.src = src; img.alt = alt || 'Project image'; img.loading = 'lazy'; img.draggable = false;
        return img;
      }
    };

    const ensureAutoSizeOnMediaLoad = (preview, minRows=1) => {
      const imgs = preview.querySelectorAll('img');
      const vids = preview.querySelectorAll('video');
      const fit = () => autoSizeRowSpan(preview, minRows);

      imgs.forEach(img => img.complete ? fit() : img.addEventListener('load', fit, {once:true}));
      vids.forEach(v => (v.readyState >= 2) ? fit() : v.addEventListener('loadeddata', fit, {once:true}));

      if (window.ResizeObserver) {
        if (preview._ro) { try { preview._ro.disconnect(); } catch(e){} }
        const ro = new ResizeObserver(() => { if (gridMode) autoSizeRowSpan(preview, minRows); });
        ro.observe(preview);
        preview._ro = ro;
      }
    };

    const approxSpansFromPixels = (pxWidth, pxHeight) => {
      const { cols, effCol, effRow } = getGridMetrics();
      const colSpan = Math.min(cols, Math.max(1, Math.round(pxWidth / effCol)));
      const rowSpan = Math.max(1, Math.round(pxHeight / effRow));
      return { colSpan, rowSpan };
    };

    const addGridResizer = (preview) => {
      if (preview.querySelector('.grid-resize')) return;
      const handle = document.createElement('div');
      handle.className = 'grid-resize';
      preview.appendChild(handle);

      const onDown = (e) => {
        if (!gridMode) return;
        e.preventDefault();
        const start = e.touches ? e.touches[0] : e;
        const startX = start.clientX, startY = start.clientY;
        const { cols, effCol, effRow } = getGridMetrics();
        let startColSpan = parseInt(preview.dataset.colSpan || '1', 10);
        let startRowSpan = parseInt(preview.dataset.rowSpan || '1', 10);

        const onMove = (ev) => {
          if (!gridMode) return;
          const p = ev.touches ? ev.touches[0] : ev;
          const dx = p.clientX - startX, dy = p.clientY - startY;

          let newCol = Math.round((startColSpan * effCol + dx) / effCol);
          let newRow = Math.round((startRowSpan * effRow + dy) / effRow);

          const minRows = Math.max(1, Math.ceil(500 / effRow)); /* enforce 500px min */
          newCol = Math.max(1, Math.min(cols, newCol));
          newRow = Math.max(minRows, newRow);

          preview.dataset.colSpan = String(newCol);
          preview.dataset.rowSpan = String(newRow);
          preview.style.gridColumn = `span ${newCol}`;
          preview.style.gridRow = `span ${newRow}`;
        };

        const onUp = () => {
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
          window.removeEventListener('touchmove', onMove);
          window.removeEventListener('touchend', onUp);
          window.removeEventListener('touchcancel', onUp);
          const { effRow } = getGridMetrics();
          autoSizeRowSpan(preview, Math.max(1, Math.ceil(500/effRow)));
        };

        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
        window.addEventListener('touchmove', onMove, {passive:false});
        window.addEventListener('touchend', onUp);
        window.addEventListener('touchcancel', onUp);
      };

      handle.addEventListener('mousedown', onDown);
      handle.addEventListener('touchstart', onDown, {passive:false});
    };

    const makeGridMovable = (preview) => {
      const onDown = (e) => {
        if (!gridMode) return;
        if (e.target && e.target.classList.contains('grid-resize')) return;
        e.preventDefault(); e.stopPropagation();

        const start = e.touches ? e.touches[0] : e;
        const { cols, effCol, effRow } = getGridMetrics();
        const rect = gridContainer.getBoundingClientRect();
        const colSpan = parseInt(preview.dataset.colSpan || '1', 10);
        const rowSpan = parseInt(preview.dataset.rowSpan || '1', 10);
        preview.classList.add('dragging');

        const onMove = (ev) => {
          if (!gridMode) return;
          const p = ev.touches ? ev.touches[0] : ev;
          const x = p.clientX - rect.left;
          const y = p.clientY - rect.top;
          let colStart = Math.floor(x / effCol) + 1;
          let rowStart = Math.floor(y / effRow) + 1;
          colStart = Math.max(1, Math.min(cols - colSpan + 1, colStart));
          rowStart = Math.max(1, rowStart);
          preview.dataset.colStart = String(colStart);
          preview.dataset.rowStart = String(rowStart);
          preview.style.gridColumn = `${colStart} / span ${colSpan}`;
          preview.style.gridRow = `${rowStart} / span ${rowSpan}`;
        };

        const onUp = () => {
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
          window.removeEventListener('touchmove', onMove);
          window.removeEventListener('touchend', onUp);
          window.removeEventListener('touchcancel', onUp);
          preview.classList.remove('dragging');
          const { effRow } = getGridMetrics();
          autoSizeRowSpan(preview, Math.max(1, Math.ceil(500/effRow)));
        };

        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
        window.addEventListener('touchmove', onMove, {passive:false});
        window.addEventListener('touchend', onUp);
        window.addEventListener('touchcancel', onUp);
      };

      preview.addEventListener('mousedown', onDown);
      preview.addEventListener('touchstart', onDown, {passive:false});
    };

    const reorganizePreviewsInGrid = () => {
      gridContainer.innerHTML = '';
      const keys = Object.keys(openPreviews);
      const count = keys.length;
      const { cols, effRow, containerHeight } = getGridMetrics();
      const minRows = Math.max(1, Math.ceil(500 / effRow)); /* 500px min */

      keys.forEach((project) => {
        const preview = openPreviews[project];
        gridContainer.appendChild(preview);

        preview.classList.add('in-grid');
        preview.style.position = 'relative';
        preview.style.transform = (count === 1) ? 'translate(0,0)' : `translate(var(--overlap-offset), var(--overlap-offset))`;
        preview.style.top = 'auto';
        preview.style.left = 'auto';
        preview.style.width = '100%';
        preview.style.height = 'auto';

        let colSpan, rowSpan;
        if (count === 1) {
          colSpan = cols;
          rowSpan = Math.max(minRows, Math.ceil(containerHeight / effRow));
        } else {
          const r = preview.getBoundingClientRect();
          const approx = approxSpansFromPixels(r.width || 600, r.height || 500);
          colSpan = Math.min(cols, Math.max(1, approx.colSpan));
          rowSpan = Math.max(minRows, approx.rowSpan);
        }

        preview.dataset.colSpan = String(colSpan);
        preview.dataset.rowSpan = String(rowSpan);

        // Auto-placement: no explicit starts so the grid places where it fits
        preview.style.gridColumn = `span ${colSpan}`;
        preview.style.gridRow = `span ${rowSpan}`;

        addGridResizer(preview);
        makeGridMovable(preview);

        requestAnimationFrame(() => {
          ensureAutoSizeOnMediaLoad(preview, minRows);
          autoSizeRowSpan(preview, minRows);
        });
      });
    };

    const resetPreviewsToAbsolute = () => {
      Object.keys(openPreviews).forEach((project) => {
        const preview = openPreviews[project];
        if (preview._ro) { try { preview._ro.disconnect(); } catch(e){} delete preview._ro; }
        const h = preview.querySelector('.grid-resize');
        if (h) h.remove();
        preview.classList.remove('in-grid', 'dragging');

        document.body.appendChild(preview);
        preview.style.position = 'absolute';
        preview.style.top = '50%';
        preview.style.left = '50%';
        preview.style.transform = 'translate(-50%, -50%)';
        preview.style.width = '600px';
        preview.style.height = 'auto';
        preview.style.gridColumn = 'auto';
        preview.style.gridRow = 'auto';
      });
    };

    const createPreviewContainer = (project) => {
      const data = projectData[project] || { image: '', blurb: 'DETAILS COMING SOON.' };

      if (openPreviews[project]) {
        const p = openPreviews[project];
        if (!gridMode) {
          p.style.top = '50%'; p.style.left = '50%'; p.style.transform = 'translate(-50%, -50%)';
        }
        return;
      }

      const preview = document.createElement('div');
      preview.className = 'preview';
      preview.style.top = '50%';
      preview.style.left = '50%';
      preview.style.transform = 'translate(-50%, -50%)';
      preview.style.zIndex = `${++zIndex}`;

      // Title above media (as requested)
      preview.innerHTML = `
        <button class="close-button" title="Close"></button>
        <div class="preview-title">${project}</div>
        <div class="preview-image-wrapper"></div>
        <p class="preview-blurb">${data.blurb}</p>
      `;

      const mediaWrap = preview.querySelector('.preview-image-wrapper');
      mediaWrap.appendChild(createMediaEl(data.image, `${project} Media`));

      preview.querySelector('.close-button').addEventListener('click', () => {
        if (preview._ro) { try { preview._ro.disconnect(); } catch(e){} delete preview._ro; }
        preview.remove();
        delete openPreviews[project];
      });

      makeDraggable(preview);

      if (gridMode) {
        gridContainer.appendChild(preview);
        preview.classList.add('in-grid');

        // Determine if this will be the only one open
        const countBefore = Object.keys(openPreviews).length; // number already open (before adding this)
        const { cols, effRow, containerHeight } = getGridMetrics();
        const minRows = Math.max(1, Math.ceil(500 / effRow));

        let colSpan, rowSpan;
        if (countBefore === 0) {
          // This is the only one â†’ fill the viewable area
          colSpan = cols;
          rowSpan = Math.max(minRows, Math.ceil(containerHeight / effRow));
          preview.style.transform = 'translate(0,0)';
        } else {
          // Otherwise open where it fits, with a minimum height of 500px
          colSpan = 2;
          rowSpan = Math.max(2, minRows);
        }

        preview.dataset.colSpan = String(colSpan);
        preview.dataset.rowSpan = String(rowSpan);
        preview.style.gridColumn = `span ${colSpan}`;
        preview.style.gridRow = `span ${rowSpan}`;

        addGridResizer(preview);
        makeGridMovable(preview);

        ensureAutoSizeOnMediaLoad(preview, minRows);
        requestAnimationFrame(() => autoSizeRowSpan(preview, minRows));
      } else {
        document.body.appendChild(preview);
      }

      openPreviews[project] = preview;
    };

    // Bind project clicks
    document.querySelectorAll('#projectList li[data-project]').forEach((item) => {
      item.addEventListener('click', () => {
        const project = item.getAttribute('data-project');
        createPreviewContainer(project);
      });
    });

    // Refit on resize in grid
    window.addEventListener('resize', () => {
      if (!gridMode) return;
      const { effRow } = getGridMetrics();
      const minRows = Math.max(1, Math.ceil(500 / effRow));
      Object.values(openPreviews).forEach(p => autoSizeRowSpan(p, minRows));
    });

    // Prevent image ghost dragging
    document.addEventListener('dragstart', (e) => {
      if (e.target && e.target.tagName === 'IMG') e.preventDefault();
    });
  </script>
</body>
</html>
